<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="SQL.csp" application="/csp/setanalysis/" default="1"><![CDATA[
<html>
<head>
<title>Batch Queries</title>

</head>

<style type="text/css">
table
{
border-collapse:collapse;
}
#grid table {
border-collapse:collapse;
background-color: white;
}
#grid table, #grid td, #grid th {
border:1px solid black;
}
#grid td, #grid th
{
padding:5px;
}
</style>

<body>
  <script language="cache" runat="server">
  Set (BatchId,name,sql,Message)=""
  Do ##class(SQL.Batch).GetOptions(.display, .maxrows, .exportdir)
  Set action=$get(%request.Data("action",1))
  if (action="batch") {
 	  Set (name,%session.Data("name"))=%request.Data("name",1)
 	  Set (sql,%session.Data("sql"))=%request.Data("sql",1)
	  Set sc = ##class(SQL.Batch).Create(name,sql)
  } elseif action="save" {
 	  Set (display,%session.Data("display"))=%request.Data("display",1)
 	  Set (maxrows,%session.Data("maxrows"))=%request.Data("maxrows",1)
 	  Set (exportdir,%session.Data("exportdir"))=%request.Data("exportdir",1)
  	  Do ##class(SQL.Batch).SetOptions(.display, .maxrows, .exportdir)
  } elseif action="detail" {
	  Set BatchId=%request.Data("batch",1)
	  Do ##class(SQL.Batch).GetDetails(BatchId,.name,.sql,.rows)
  } elseif action="delete" {
	  Set BatchId=%request.Data("batch",1)
	  Do ##class(SQL.Batch).RemoveBatch(BatchId)
	  Set BatchId=""
  } elseif action="export" {
	  Set BatchId=%request.Data("batch",1)
  	  &sql(Select Name Into :Name From SQL.Batch Where ID = :BatchId)
	  Set File=exportdir_$ZStrip(Name,"*CWP")_$ZDATE($H,8)_"_"_$TR($ZTime($P($H,",",2)),":")_".csv"
	  Set IO = $IO
	  Set Ok=1
	  Open File:"WNS":1 Else  Set Ok=0
	  If 'Ok {
		  Set BatchId=""
		  Set Message="Could not Export to File "_File
	  } else {
		  Use File
		  Write !
		  For iCol=1:1:$ListLength(^SQL.BatchResultD(BatchId)) {
	  	    Write $List(^SQL.BatchResultD(BatchId),iCol),";"
		  }
		  Write !
		    Set iRow=""
		  For iCountRows=1:1 {
	        Set iRow=$Order(^SQL.BatchResultD(BatchId,iRow),1,Values) If iRow="" Quit
	      	For iCol=1:1:$ListLength(Values) {
	    	  Write $List(Values,iCol),";"
	        }
	        Write !
		  }
		  Close File
		  Use IO
		  Set BatchId=""
		  Set Message="SQL Batch "_Name_" results exported to file "_File 
	  }
  }
  Do ##class(SQL.Batch).GetList(.Batches)
 </script>
  
  <table>
  <form>
   <tr valign="top">
      <td>
        <table>
          <tr><td><a href='SQL.csp?action=refresh'>[ refresh ]</a></td></tr>
          <tr align="left">
            <th colspan=2>Name</th>
            <th>Started</th>
            <th>Time</th>
          </tr>
          <csp:loop counter="iBatch" FROM="1" TO ="#(+Batches)#">
            <tr>
              <td><a href='SQL.csp?action=detail&batch=#($List(Batches(iBatch),1))#'>#($List(Batches(iBatch),2))#</a></td>
			  <td>
			    <a href='SQLExport.csp?action=export&batch=#($List(Batches(iBatch),1))#'> <img src='excel.gif' border=0></a>
			    <a href='SQL.csp?action=export&batch=#($List(Batches(iBatch),1))#'> file </a>
			  </td>
			  <td>#($List(Batches(iBatch),3))#</td>
			  <td>#($List(Batches(iBatch),4))#</td>
              <td><a href='SQL.csp?action=delete&batch=#($List(Batches(iBatch),1))#'>[ x ]</a></td>
            </tr>
          </csp:loop>
        </table>
      </td>
      <td>&nbsp;&nbsp;</td>
      <td>
        <table>
          <tr>
            <td>
			    <table>
			      <tr><td valign="top">Batch Name</td>
			      <td><input type="text" name="name" size=100 value="#(name)#"/>
			      </td></tr>
			      <tr><td valign="top">SQL Query</td><td><textarea name="sql" id="sql" cols="80" rows=4>#(sql)#</textarea></td></tr>
			      <tr><td></td><td>
			        <button type="submit" name="action" value="batch">batch</button>
			      </td></tr>
				</table>
			</td>
		  </tr>
		  <csp:if condition="BatchId>0">
		  <tr>
		    <td>
		      <table id="grid">
                  <script language="cache" runat="server">
                    Write "<tr>"
                    For iCol=1:1:$ListLength(^SQL.BatchResultD(BatchId)) {
                    	Write "<th align='left'>",$List(^SQL.BatchResultD(BatchId),iCol),"</th>"
                    }
                    Write "</tr>",!
                    Set iRow=""
                    For iCountRows=1:1 {
	                    Set iRow=$Order(^SQL.BatchResultD(BatchId,iRow),1,Values) If iRow="" Quit
	                    If iCountRows>maxrows {
	                    	Write "<tr><td align='left' colspan=999>",(iCountRows-1)," / ",rows," displayed</td></tr>"		                    
		                    Quit
	                    }
	                    Write "<tr>"
	                    For iCol=1:1:$ListLength(Values) {
	                    	Write "<td align='left'>",$List(Values,iCol),"</td>"
	                    }
	                    Write "</tr>",!
                    }
                 </script>		        
		      </table>
		    </td>
		  </tr>
          </csp:if>
          <csp:if condition="$Length(Message)>0">
          <tr>
            <td colspan=20>#(Message)#</td>
          </tr>
          </csp:if>
		</table>  	  
	  </td>
	  <td>
        <table>
          <tr>
            <td>Display</td>
            <td><select name="display">
		          <option value=0 #($S(display=0:"selected",1:""))#>Logical Mode</option>
		          <option value=1 #($S(display=1:"selected",1:""))#>ODBC Mode</option>
		          <option value=2 #($S(display=2:"selected",1:""))#>Display Mode</option>
		        </select></td>
		  </tr>  
		  <tr>
		    <td>Max.Rows</td>
		    <td><input type="text" name="maxrows" size=8 value="#(maxrows)#"/> </td>
		  </tr>
		  <tr>
            <td>ExportDir</td>
            <td><input type="text" name="exportdir" size=15 value="#(exportdir)#"/></td>
          </tr>
          <tr>
			<td></td><td><button type="submit" name="action" value="save">save</button>
          </tr>
	  </td>
	</tr>
  </form>
</table>  
  
</body>
</html>
]]></CSP>
</Export>
