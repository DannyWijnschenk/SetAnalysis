<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="autocomplete.csp" application="/csp/setanalysis/" default="1"><![CDATA[
<html>
<head>

<title>	Auto complete </title>

</head>

<body>

<script language="cache" runat="server">
	If $get(%request.Data("domain",1))'="" Set %session.Data("domain")=%request.Data("domain",1)
</script>

<script language="JavaScript" type="text/javascript">

function lookupChange()
{
   var value = self.document.frmDemo.input.value;
   if (value.length > 2) {
     // now invoke server-side method
     var lookupElements = self.document.getElementById("lookupitems");
     lookupElements.innerHTML = 'Searching for entities... <br><img src="wait.gif">';
     #server(..LookupServerEntry(value))#
   }
   return true;
}

function selectLookupElement(value)
{
	self.document.frmDemo.input.value = value;
	setCaretPosition(self.document.frmDemo.input, 99999);
}

function setCaretPosition(ctrl, pos){
	if (ctrl.setSelectionRange) {
      ctrl.focus();
      ctrl.setSelectionRange(pos,pos);
    }
    else if (ctrl.createTextRange) {
      var range = ctrl.createTextRange();
      range.collapse(true);
      range.moveEnd('character', pos);
      range.moveStart('character', pos);
      range.select();
    }
}
</script>

<script arguments="value:%String,manual:%Boolean" language="Cache" method="LookupServerEntry">
	set value=$tr(value,$C(10)," ")  ;no lf in js
	set origvalue=$piece(value," ",1,*-1)   ;sentence without last word
	set simvalue="" if $E(value,*)=" " set simvalue=$p(value," ",*-1)  ;get last word of sentence if ends with space
	set simorigvalue=$piece(value," ",1,*-2)  ;sentence without last word if ends with space
	set value=$Piece(value," ",*)  ;last word : todo : use iKnow to get last *concept*
	If value["." Set value=$Piece(value,".",*)  ;if last word ends with period, take only last part 
	try {
		Set objDomain=##class(%iKnow.Domain).Open(%session.Get("domain"))
		If objDomain="" Set Elements="No iKnow domain available. Use url?domain=mydomain" Quit  ;no iKnow domain available
		Set domainId=objDomain.Id

		Set Elements=""

		;get list of similar concepts of last used word (todo : use iKnow to get the last concept ...) 
		Do ##class(%iKnow.Queries.EntityAPI).GetSimilar(.Result,domainId,value,1,50,,,,)
		Set iResult="",iCount=0
		Set Elements=Elements_"<table><tr><td>Similar to "_value_"</td><td>Frequency&nbsp;&nbsp;</td><td>Spread</td></tr>"
		For {
	    	Set iResult=$Order(Result(iResult)) If iResult="" Quit
			Set iCount=iCount+1
	    	Set Entity=$List(Result(iResult),2)
			Do ..AddElement(.Elements,origvalue,Entity,$List(Result(iResult),3),$List(Result(iResult),4))
		}
		Set Elements=Elements_"</table>"

		if simvalue'="" {  //list all crc's, so user can pick one of them and finish the sentence automatically...
			Do ##class(%iKnow.Queries.CrcAPI).GetByEntities(.Result,domainId,$lb(simvalue),1,50)
			Set iResult=""
			Set Elements=Elements_"<table><tr><td>CRC with "_simvalue_"</td><td>Frequency&nbsp;&nbsp;</td><td>Spread</td></tr>"
			For {
		    	Set iResult=$Order(Result(iResult)) If iResult="" Quit
				Set iCount=iCount+1
		    	Set Entity=$List(Result(iResult),2)
				Set CRC=$List(Result(iResult),2)_" "_$List(Result(iResult),3)_" "_$List(Result(iResult),4)
				Do ..AddElement(.Elements,simorigvalue,CRC,$List(Result(iResult),5),$List(Result(iResult),6))
			}
			Set Elements=Elements_"</table>"
		}
		
		If iCount=0 Set Elements = "no entities found"
	} catch {
		Set Elements = "Error while retrieving entity list : "_$ze
	}
	;js to inject elements into page
    &javascript< var lookupElements = self.document.getElementById("lookupitems"); >
	&javascript< lookupElements.innerHTML = '#(Elements)#'; >
    Quit   
</script>

<script arguments="Elements:%String,replaceText:%String,entity:%String,frequency:%Integer,spread:%Integer" language="Cache" method="AddElement">
	;escape any single quote
	Set Find=0 For  Set Find=$Find(entity,"'",Find) Quit:Find=0  Set entity=$E(entity,1,Find-2)_"\"_$E(entity,Find-1,*),Find=Find+1
	Set Elements=Elements_"<tr><td><a href=""Javascript:selectLookupElement(\'"_replaceText_" "_entity_"\');"">"_entity_"</a></td><td>"_frequency_"</td><td>"_spread_"</td>"
	Set Elements=Elements_"</tr>"
</script>

<!--- put some logos for nice layout : <img src="voogd.jpg"> & <img src="iknow.jpg" width=100 height=65> -->
<span style='color:DarkBlue;font-size:30px'> Autocomplete demo.</span>
<br><br>New text :<br>
<form name="frmDemo">
  <textarea name="input" rows=20 cols=80 onkeyup="lookupChange();"></textarea>
  <div id="lookupitems">
  </div>

</form>
</body>
</html>
]]></CSP>
</Export>
